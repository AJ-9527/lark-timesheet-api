<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>工时查询 · Timesheet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, "PingFang SC", "Microsoft YaHei", sans-serif;
      background: #f5f5f5;
      color: #111;
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
      padding: 18px 20px 28px;
    }

    /* ===== Logo 区 ===== */
    .logo-area {
      padding-top: 28px;
      padding-bottom: 18px;
      background: #ffffff;
      border-bottom: 1px solid #eaeaea;
    }
    .logo-wrap {
      display: flex;
      justify-content: center;
    }
    .logo-wrap img {
      height: 78px;
      max-width: 90%;
      object-fit: contain;
    }
    @media (max-width: 420px) and (orientation: portrait) {
      .logo-area { padding-top: 24px; padding-bottom: 16px; }
      .logo-wrap img { height: 70px; }
    }

    h1 {
      font-size: 22px;
      text-align: center;
      margin: 12px 0 6px;
      line-height: 1.2;
    }

    .subtitle {
      text-align: center;
      color: #777;
      font-size: 13px;
      margin-bottom: 16px;
      line-height: 1.4;
    }

    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 18px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }

    .card-title {
      font-size: 16px;
      font-weight: 800;
      margin-bottom: 14px;
      line-height: 1.4;
    }

    .form-row { margin-bottom: 18px; }

    label {
      display: block;
      font-size: 15px;
      font-weight: 800;
      color: #222;
      margin-bottom: 6px;
      line-height: 1.25;
    }

    .en {
      font-size: 12px;
      color: #666;
      margin-top: 2px;
      font-weight: 500;
    }

    input[type="text"],
    input[type="tel"],
    input[type="date"] {
      width: 100%;
      padding: 12px 14px;
      font-size: 15px;
      border-radius: 8px;
      border: 1px solid #ccc;
      outline: none;
      background: #fafafa;
      display: block;
      background-clip: padding-box;
    }

    /* 蓝色 focus */
    input[type="date"]:focus,
    input[type="text"]:focus,
    input[type="tel"]:focus {
      border-color: #3370ff;
      box-shadow: 0 0 0 2px rgba(51,112,255,0.18);
      background-color: #fff;
      outline: none;
    }

    /* 手机号 + 获取验证码 同一行 */
    .phone-row {
      display: grid;
      grid-template-columns: 1fr 120px;
      gap: 10px;
      align-items: stretch;
    }
    .phone-row input { height: 48px; }
    .phone-row button {
      height: 48px;
      padding: 0;
      border: none;
      border-radius: 8px;
      background: #3370ff;
      color: #fff;
      font-size: 14px;
      font-weight: 800;
      cursor: pointer;
      line-height: 1.1;
    }
    .phone-row button:active { background: #295ee0; }
    .phone-row button:disabled { opacity: 0.65; cursor: not-allowed; }

    /* 日期布局 */
    .row-inline {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      align-items: start;
    }
    @media (max-width: 420px) {
      .row-inline { grid-template-columns: 1fr; gap: 12px; }
    }
    .date-wrap {
      overflow: hidden;
      border-radius: 8px;
    }
    .date-wrap input[type="date"] {
      border-radius: 0;
      width: 100%;
      -webkit-appearance: none;
      appearance: none;
    }
    .date-wrap:focus-within {
      box-shadow: 0 0 0 2px rgba(51,112,255,0.18);
    }

    /* 主按钮 */
    button.primary {
      width: 100%;
      padding: 12px 14px;
      border: none;
      border-radius: 8px;
      background: #3370ff;
      color: #fff;
      font-size: 15px;
      font-weight: 800;
      cursor: pointer;
      margin-top: 6px;
      line-height: 1.15;
    }
    button.primary:active { background: #295ee0; }
    button.primary:disabled { opacity: 0.65; cursor: not-allowed; }

    .status {
      font-size: 14px;
      margin-top: 10px;
      min-height: 20px;
      line-height: 1.35;
    }
    .error { color: #d93026; }
    .success { color: #188038; }
    .info { color: #555; }

    /* ===== 表格基础样式 ===== */
    table {
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 10px;
    }
    th {
      background: #f0f2f5;
      padding: 8px;
      border-bottom: 2px solid #ddd;
      text-align: left;
      vertical-align: bottom;
    }
    td {
      padding: 10px 6px;
      border-bottom: 1px solid #eee;
      vertical-align: top;
    }

    .total-row {
      text-align: right;
      margin-top: 12px;
      font-weight: 800;
      font-size: 14px;
    }

    .muted {
      text-align: center;
      color: #888;
      font-size: 12px;
      margin-top: 18px;
      line-height: 1.45;
    }
    .hidden { display: none; }

    /* =====================================================
       ✅ 结果区：只滚动表格，合计固定，日期列固定
       ===================================================== */

    /* 只让“表格本体”横向滚动 */
    #result-table-scroll {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* 表格按内容自然展开，装不下就滚动 */
    #result-table-scroll table {
      width: max-content;
      min-width: 100%;
    }

    /* 所有列默认一行显示（更像“表格”） */
    #result-table-scroll th,
    #result-table-scroll td {
      white-space: nowrap;
    }

    /* ✅ 日期列固定（左侧 sticky） */
    #result-table-scroll th:nth-child(1),
    #result-table-scroll td:nth-child(1) {
      position: sticky;
      left: 0;
      z-index: 3;
      background: #ffffff; /* td 背景 */
      min-width: 108px;
    }

    /* 表头日期列背景要和 th 一致 */
    #result-table-scroll thead th:nth-child(1) {
      background: #f0f2f5;
      z-index: 4;
    }

    /* 给 sticky 列加一个轻微分隔线，视觉更清晰 */
    #result-table-scroll th:nth-child(1),
    #result-table-scroll td:nth-child(1) {
      box-shadow: 1px 0 0 rgba(0,0,0,0.06);
    }

    /* 横滑提示 */
    .scroll-hint {
      text-align: center;
      font-size: 12px;
      color: #888;
      margin-top: 8px;
    }
    .scroll-hint .en {
      display: block;
      margin-top: 4px;
    }
  </style>
</head>

<body>

  <div class="logo-area">
    <div class="logo-wrap">
      <img src="/logo.png" alt="Lumi HVAC Ltd Logo" />
    </div>
  </div>

  <div class="container">
    <h1>工时查询 · Timesheet</h1>
    <div class="subtitle">
      查询您的个人工时记录 · View your personal working hours
    </div>

    <!-- 登录 -->
    <div class="card" id="login-card">
      <div class="card-title">登录 Login</div>

      <div class="form-row">
        <label>手机号<br><span class="en">Phone</span></label>
        <div class="phone-row">
          <input id="phone-input" type="tel" placeholder="6041234567" />
          <button id="btn-send-code">
            获取验证码<br><span class="en" style="color:#fff;">Get Code</span>
          </button>
        </div>
      </div>

      <div class="form-row">
        <label>验证码<br><span class="en">Verification Code</span></label>
        <input id="code-input" type="text" placeholder="6位数字 / 6-digit code" />
      </div>

      <button id="btn-login" class="primary">
        登录 · Login
      </button>

      <div id="login-status" class="status info"></div>
    </div>

    <!-- 查询 -->
    <div class="card hidden" id="query-card">
      <div class="card-title">
        查询条件 Filter
        <div id="current-user-label" style="font-size:13px;color:#777;margin-top:6px;"></div>
      </div>

      <div class="form-row row-inline">
        <div>
          <label>开始日期<br><span class="en">Start Date</span></label>
          <div class="date-wrap">
            <input id="start-date" type="date" />
          </div>
        </div>
        <div>
          <label>结束日期<br><span class="en">End Date</span></label>
          <div class="date-wrap">
            <input id="end-date" type="date" />
          </div>
        </div>
      </div>

      <button id="btn-query" class="primary">查询工时 · Query</button>
      <div id="query-status" class="status info"></div>
    </div>

    <!-- 结果 -->
    <div class="card hidden" id="result-card">
      <div class="card-title">查询结果 Results</div>

      <div id="result-empty" class="info">
        暂无数据，请先选择日期并查询。 No data. Please select dates and query.
      </div>

      <div id="result-table-wrapper" class="hidden">
        <!-- ✅ 只滚动表格 -->
        <div id="result-table-scroll">
          <table>
            <thead>
              <tr>
                <th>日期<br><span class="en">Date</span></th>
                <th>项目<br><span class="en">Project</span></th>
                <th>上班<br><span class="en">Start</span></th>
                <th>下班<br><span class="en">End</span></th>
                <th>工时<br><span class="en">Hours</span></th>
              </tr>
            </thead>
            <tbody id="result-tbody"></tbody>
          </table>
        </div>

        <div class="scroll-hint">
          ← 左右滑动查看完整内容 →<br>
          <span class="en">← Swipe left/right to view full content →</span>
        </div>


        <!-- ✅ 合计固定：放在滚动容器外 -->
        <div id="total-row" class="total-row"></div>
      </div>
    </div>

    <div class="muted">
      本页面仅用于查询个人工时，如需协助请联系办公室。<br>
      This page is for personal timesheet viewing only.
    </div>
  </div>

  <script>
    const btnSendCode = document.getElementById("btn-send-code");
    const btnLogin = document.getElementById("btn-login");
    const btnQuery = document.getElementById("btn-query");

    const phoneInput = document.getElementById("phone-input");
    const codeInput = document.getElementById("code-input");
    const loginStatus = document.getElementById("login-status");

    const loginCard = document.getElementById("login-card");
    const queryCard = document.getElementById("query-card");
    const resultCard = document.getElementById("result-card");
    const queryStatus = document.getElementById("query-status");

    const startDateInput = document.getElementById("start-date");
    const endDateInput = document.getElementById("end-date");
    const currentUserLabel = document.getElementById("current-user-label");

    const resultEmpty = document.getElementById("result-empty");
    const resultTableWrapper = document.getElementById("result-table-wrapper");
    const resultTbody = document.getElementById("result-tbody");
    const totalRow = document.getElementById("total-row");

    let sessionToken = null;
    let currentPersonName = null;

    let countdownTimer = null;
    let countdownSeconds = 0;
    const sendCodeOriginalHtml = btnSendCode.innerHTML;

    function setLoginStatus(msg, type) {
      loginStatus.textContent = msg || "";
      loginStatus.className = "status " + (type || "info");
    }

    function setQueryStatus(msg, type) {
      queryStatus.textContent = msg || "";
      queryStatus.className = "status " + (type || "info");
    }

    function setLoading(btn, html) {
      btn.dataset.old = btn.innerHTML;
      btn.innerHTML = html;
      btn.disabled = true;
    }

    function clearLoading(btn) {
      if (btn.dataset.old) btn.innerHTML = btn.dataset.old;
      btn.disabled = false;
    }

    function updateCountdownText() {
      btnSendCode.innerHTML = `重新获取(${countdownSeconds}s)<br><span class="en" style="color:#fff;">Get Code</span>`;
    }

    function startCountdown(seconds) {
      countdownSeconds = seconds;
      btnSendCode.disabled = true;
      updateCountdownText();

      if (countdownTimer) clearInterval(countdownTimer);
      countdownTimer = setInterval(() => {
        countdownSeconds--;
        if (countdownSeconds <= 0) {
          clearInterval(countdownTimer);
          countdownTimer = null;
          btnSendCode.disabled = false;
          btnSendCode.innerHTML = sendCodeOriginalHtml;
        } else {
          updateCountdownText();
        }
      }, 1000);
    }

    async function requestCode() {
      const phone = phoneInput.value.trim();
      if (!phone) {
        setLoginStatus("请输入手机号 / Please enter phone number.", "error");
        return;
      }
      if (countdownTimer) return;

      btnSendCode.disabled = true;
      btnSendCode.innerHTML = "发送中...<br><span class='en' style='color:#fff;'>Sending...</span>";
      setLoginStatus("");

      try {
        const res = await fetch("/api/request_code", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ phone })
        });
        const data = await res.json();

        if (data.code !== 0) {
          setLoginStatus(data.msg || "发送失败 / Failed", "error");
          btnSendCode.disabled = false;
          btnSendCode.innerHTML = sendCodeOriginalHtml;
          return;
        }

        setLoginStatus("验证码已发送，请查收短信。 Verification code sent. Please check your SMS.", "success");
        startCountdown(60);

      } catch (e) {
        setLoginStatus("网络错误 / Network error", "error");
        btnSendCode.disabled = false;
        btnSendCode.innerHTML = sendCodeOriginalHtml;
      }
    }

    async function doLogin() {
      const phone = phoneInput.value.trim();
      const code = codeInput.value.trim();
      if (!phone || !code) {
        setLoginStatus("请填写手机号和验证码 / Enter phone & code", "error");
        return;
      }

      setLoading(
        btnLogin,
        "登录中...<br><span class='en' style='color:#fff;'>Logging in...</span>"
      );
      setLoginStatus("");

      try {
        const res = await fetch("/api/verify_code", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ phone, code })
        });
        const data = await res.json();

        if (data.code !== 0) {
          setLoginStatus(data.msg || "登录失败 / Login failed", "error");
          return;
        }

        sessionToken = data.token;
        currentPersonName = data.personName;

        loginCard.classList.add("hidden");
        queryCard.classList.remove("hidden");
        resultCard.classList.remove("hidden");

        currentUserLabel.textContent = `当前用户 Current: ${currentPersonName || ""}`;

        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, "0");
        const dd = String(today.getDate()).padStart(2, "0");
        const todayStr = `${yyyy}-${mm}-${dd}`;
        startDateInput.value = todayStr;
        endDateInput.value = todayStr;

      } catch (e) {
        setLoginStatus("网络错误 / Network error", "error");
      } finally {
        clearLoading(btnLogin);
      }
    }

    async function queryTimesheet() {
      if (!sessionToken) {
        setQueryStatus("请先登录 / Please login first", "error");
        return;
      }

      const start = startDateInput.value;
      const end = endDateInput.value;
      if (!start || !end) {
        setQueryStatus("请选择开始和结束日期 / Select dates", "error");
        return;
      }

      setLoading(btnQuery, "查询中...<br><span class='en' style='color:#fff;'>Querying...</span>");
      setQueryStatus("");

      try {
        const params = new URLSearchParams({
          start_date: start,
          end_date: end,
          session_token: sessionToken
        });

        const res = await fetch("/api/timesheet?" + params.toString());
        const data = await res.json();

        if (data.code !== 0) {
          setQueryStatus(data.msg || "查询失败 / Query failed", "error");
          renderResults([]);
          return;
        }

        setQueryStatus("查询完成 / Done", "success");
        renderResults(data.data || []);

      } catch (e) {
        setQueryStatus("网络错误 / Network error", "error");
        renderResults([]);
      } finally {
        clearLoading(btnQuery);
      }
    }

    function renderResults(records) {
      if (!records || records.length === 0) {
        resultEmpty.classList.remove("hidden");
        resultTableWrapper.classList.add("hidden");
        resultTbody.innerHTML = "";
        totalRow.innerHTML = "";
        return;
      }

      resultEmpty.classList.add("hidden");
      resultTableWrapper.classList.remove("hidden");
      resultTbody.innerHTML = "";

      let total = 0;
      records.forEach(r => {
        total += Number(r.hours || 0);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.date || ""}</td>
          <td>${r.project || ""}</td>
          <td>${r.startTime || ""}</td>
          <td>${r.endTime || ""}</td>
          <td>${r.hours != null ? r.hours : ""}</td>
        `;
        resultTbody.appendChild(tr);
      });

      totalRow.innerHTML = `合计工时<br><span class="en">Total Hours: ${total.toFixed(2)}</span>`;
    }

    btnSendCode.addEventListener("click", requestCode);
    btnLogin.addEventListener("click", doLogin);
    btnQuery.addEventListener("click", queryTimesheet);
  </script>
</body>
</html>
